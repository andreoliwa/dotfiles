#!/usr/bin/env python3
"""Backup Docker volumes."""
import argparse
from pathlib import Path

from dotfiles_utils import shell


def main():
    """Main function."""
    parser = argparse.ArgumentParser(description="backup Docker volumes")
    parser.add_argument("backup_dir", help="directory to store the backups")
    parser.add_argument("volume_name", nargs="+", help="Docker volume name")
    args = parser.parse_args()

    backup_dir = Path(args.backup_dir)
    backup_dir.mkdir(parents=True, exist_ok=True)
    for volume in args.volume_name:
        # TODO: when piping from stdin, stdout is printed only at the end (buffered)
        shell(
            "docker run --rm -i -v {backup_dir}:/backup -v /var/lib/docker/volumes:/volumes "
            "busybox tar czf /backup/{volume}.tgz /volumes/{volume}".format(backup_dir=backup_dir, volume=volume)
        )


# TODO Command to restore:
# docker run --rm -i -v {backup_dir}:/backup -v /var/lib/docker:/docker busybox tar xzvf /backup/{volume}.tgz -C /docker
# TODO: Delete the destination directory before restoring?
if __name__ == "__main__":
    main()
