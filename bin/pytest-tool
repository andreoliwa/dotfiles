#!/usr/bin/env python3
"""Py.test helper tools."""
import re

import click

from dotfiles_utils import shell

TEST_REGEX = re.compile(r"___ (test[^ ]+) ___")


@click.group()
def tool():
    """Py.test helper tools."""
    pass


@tool.command()
@click.argument("failed_results_file", type=click.File())
def failed_results(failed_results_file):
    """Parse a file with the output of failed tests, then re-run only those failed tests."""
    contents = failed_results_file.read()
    all_tests = TEST_REGEX.findall(contents)
    expression = " or ".join(all_tests)
    shell(f"pytest -vv -k '{expression}'")


if __name__ == "__main__":
    tool()
