- name: "Check last execution"
  shell: test ! -f ~/.config/dotfiles/last_execution_docker || test -n "$(find ~/.config/dotfiles -name last_execution_docker -cmin +30)"
  register: last_execution_docker
  ignore_errors: true

- name: "Stop all containers"
  shell: "docker ps -q | xargs docker stop"
  when: last_execution_docker is success
  # No containers might be running
  ignore_errors: true

- name: "List all volumes related to a Docker Compose project"
  command: "docker volume ls --filter label=com.docker.compose.project -q"
  register: docker_compose_volumes
  when: last_execution_docker is success

- name: "Create {{ backup_dir }}/docker_volumes/"
  file:
    state: directory
    path: "{{ backup_dir }}/docker_volumes/"

- name: "Backup each volume in {{ backup_dir }}/docker_volumes/"
  command: "docker-volume backup {{ backup_dir }}/docker_volumes/ {{ item }}"
  with_items: "{{ docker_compose_volumes.stdout_lines }}"
  when: last_execution_docker is success

- name: "Touch file to avoid executing again"
  file:
    state: touch
    path: ~/.config/dotfiles/last_execution_docker
  when: last_execution_docker is success
