# https://github.com/pyinvoke/invoke
- name: "invoke: Install with pipx"
  command: "pipx install invoke"
  register: result
  failed_when:
    - result.rc > 0
    - "'Not installing to existing directory' not in result.stderr"
    - "'already seems to be installed' not in result.stdout"

- name: "invoke: Clone conjuring"
  git:
    repo: git@github.com:andreoliwa/conjuring.git
    dest: "{{ project_root }}/conjuring"

- name: "invoke: Clone conjuring-private"
  git:
    repo: git@github.com:andreoliwa/conjuring-private.git
    dest: "{{ project_root }}/conjuring-private"

- name: "invoke: Link .invoke.yaml"
  file:
    src: "{{ project_root }}/conjuring/.invoke.yaml"
    dest: "{{ dotfiles_user_home }}/.invoke.yaml"
    state: link
    force: yes

- name: "invoke: Link invoke_home.py to user home"
  file:
    src: "{{ project_root }}/conjuring/invoke_home.py"
    dest: "{{ dotfiles_user_home }}/invoke_home.py"
    state: link
    force: yes
  register: invoke_home_file

- name: "invoke: Link invoke_home.py to /usr/local"
  file:
    src: "{{ invoke_home_file.src }}"
    dest: "/usr/local/invoke_home.py"
    state: link
    force: yes
    follow: no
  become: true
  ignore_errors: yes
  register: link_invoke_home_usr_local

- name: "invoke: Debug link"
  debug:
    var: link_invoke_home_usr_local

- name: "invoke: Link invoke_root_work.py"
  file:
    src: "{{ project_root }}/conjuring-private/invoke_root_work.py"
    dest: "{{ dotfiles_user_home }}/_invoke_root_work.py"
    state: link

- name: "invoke: Inject ipdb"
  command: "pipx inject invoke ipdb"

- name: "invoke: conjuring: Rename pyproject.toml"
  command: "mv pyproject.toml _pyproject.toml"
  args:
    chdir: "{{ project_root }}/conjuring/"
  ignore_errors: yes

- name: "invoke: conjuring: Inject"
  command: "pipx inject -e invoke ."
  args:
    chdir: "{{ project_root }}/conjuring/"

- name: "invoke: conjuring: Restore pyproject.toml"
  shell: "mv _pyproject.toml pyproject.toml"
  args:
    chdir: "{{ project_root }}/conjuring/"
  ignore_errors: yes

- name: "invoke: conjuring-private: Rename pyproject.toml"
  command: "mv pyproject.toml _pyproject.toml"
  args:
    chdir: "{{ project_root }}/conjuring-private/"
  ignore_errors: yes

- name: "invoke: conjuring-private: Inject"
  command: "pipx inject -e invoke ."
  args:
    chdir: "{{ project_root }}/conjuring-private/"

- name: "invoke: conjuring-private: Restore pyproject.toml"
  shell: "mv _pyproject.toml pyproject.toml"
  args:
    chdir: "{{ project_root }}/conjuring-private/"
  ignore_errors: yes

- name: "invoke: Tab completion"
  shell: "invoke --print-completion-script=bash > ~/.local/share/bash-completion/completions/invoke.bash-completion"
